<!doctype html><html lang=ja-jp><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-36ZKMZ1PCV"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-36ZKMZ1PCV")}</script><meta charset=UTF-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=robots content="index, follow"><meta name=author content><meta name=description content="くすはさんのブログです。日常だったり趣味だったり技術的なことだったりを書いていくよ。"><link rel=author type=text/plain href=/humans.txt><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon href=/favicon.ico type=image/x-icon><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta name=msapplication-TileImage content="/mstile-144x144.png"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><link rel=mask-icon href=/safari-pinned-tab.svg color=#494f5c><meta itemprop=name content="Google Cloud Run + Rust で Slack の bot を作ってみた"><meta itemprop=description content="最近、趣味で Rust を触っているんですが、その勉強の一環で Slack bot を作ってみたので、その備忘録。
できたもの"><meta itemprop=datePublished content="2022-04-22T23:00:00+09:00"><meta itemprop=dateModified content="2022-04-22T23:00:00+09:00"><meta itemprop=wordCount content="2676"><meta itemprop=image content="https://blog.kusuha.com/posts/2022/04/create-slack-bot-with-cloud-run-and-rust/feature.png"><meta itemprop=keywords content="GCP,Rust,Slack"><meta property="og:url" content="https://blog.kusuha.com/posts/2022/04/create-slack-bot-with-cloud-run-and-rust/"><meta property="og:site_name" content="くすブロ"><meta property="og:title" content="Google Cloud Run + Rust で Slack の bot を作ってみた"><meta property="og:description" content="最近、趣味で Rust を触っているんですが、その勉強の一環で Slack bot を作ってみたので、その備忘録。
できたもの"><meta property="og:locale" content="ja_jp"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-22T23:00:00+09:00"><meta property="article:modified_time" content="2022-04-22T23:00:00+09:00"><meta property="article:tag" content="GCP"><meta property="article:tag" content="Rust"><meta property="article:tag" content="Slack"><meta property="og:image" content="https://blog.kusuha.com/posts/2022/04/create-slack-bot-with-cloud-run-and-rust/feature.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.kusuha.com/posts/2022/04/create-slack-bot-with-cloud-run-and-rust/feature.png"><meta name=twitter:title content="Google Cloud Run + Rust で Slack の bot を作ってみた"><meta name=twitter:description content="最近、趣味で Rust を触っているんですが、その勉強の一環で Slack bot を作ってみたので、その備忘録。
できたもの"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Google Cloud Run + Rust で Slack の bot を作ってみた","name":"Google Cloud Run \u002b Rust で Slack の bot を作ってみた","description":"最近、趣味で Rust を触っているんですが、その勉強の一環で Slack bot を作ってみたので、その備忘録。\nできたもの ","keywords":["GCP","Rust","Slack"],"articleBody":"最近、趣味で Rust を触っているんですが、その勉強の一環で Slack bot を作ってみたので、その備忘録。\nできたもの 使った物 Rust Google Cloud Platform Cloud Run Artifact Registry Cloud Build Cloud Logging Cloud Storage 上記4つは Google Cloud CLI で gcloud run deploy すると使われるものたち Secret Manager なぜこれを作ったのか Slackでアンパンマンがちょっと流行った話 / Zenn.dev https://zenn.dev/dividebyzero/articles/2815cef7cd446f\nこの記事を読んだのがきっかけ。ちょうど手頃な Slack bot だったので、 bot をデプロイするまでの一連の勉強には良いかなと。\nあとは、このツイート記事を読んだことで「オッ AWS Lambda だけで完結して作れるじゃん」と思って機運が高まったのが着手の要因に。\nついに API-GW なしに Lambda だけで HTTPS なエンドポイントを生やせるように・・・！\nGitHub とか Slack からの Webhook 受けとしても使いやすくなるし、良いすね🤗\n/ \"AWS Lambda Function URLs: built-in HTTPS endpoints for your Lambda functions\" https://t.co/Evs4OAL2Iv pic.twitter.com/zaEb3Epeo2\n— Tori Hara (@toricls) April 6, 2022 (何故AWSではなくGCPで実装することになったのかは後述)\nやったこと 1. Slack で bot アプリケーションを新規作成 Slack Appの作り方を丁寧に残す【BotとEvent APIの設定編】 - Zenn\n上記記事がかなり詳しく書いてくれていて、ほぼこれの通りに作ったので、詳細は割愛。\n2. Rust でコーディング 2.1 サーバー待ち受け Cloud RunでRustのAPI Serverを動かす - Zenn\nまず、上記記事を参考に、 Rust でサーバー待ち受けのコードを用意。ここも詳細割愛。\n2.2 Slack URL Verification を通す その後、Slack App でイベントを受け取るために、 URL Verification を通す必要があるので、そのコードを用意。 ここも、 1. で参考にした記事を参考にしています。\nやっていることはシンプルで、 1. で作った時に発行されている Verification Token を環境変数 SLACK_VERIFICATION_TOKEN に定義しておき、それと token との一致確認と、 type が url_verification であるかを確認して、問題が無ければ challenge の内容を JSON 形式で返しています。\nasync fn slack(Json(payload): Json\u003cSlackRequest\u003e) -\u003e impl IntoResponse { match env::var(\"SLACK_VERIFICATION_TOKEN\") { Ok(token) =\u003e { if payload.token != token { return (StatusCode::UNAUTHORIZED, String::new()); } } Err(message) =\u003e { println!(\"SLACK_VERIFICATION_TOKEN is not available: {}\", message); return (StatusCode::INTERNAL_SERVER_ERROR, String::new()); } } if let Some(r#type) = payload.r#type { if r#type == \"url_verification\" { match payload.challenge { Some(challenge) =\u003e { return ( StatusCode::OK, format!(r#\"{{\"challenge\":\"{}\"}}\"#, challenge), ) } None =\u003e return (StatusCode::BAD_REQUEST, String::new()), } } } return (StatusCode::OK, String::new()); } なお、環境変数への定義は、デプロイ時には Secret Manager を利用しつつ、開発中は .env ファイルを作ってそこに環境変数を定義し、 rust-dotenv crate を使って読み込んでいます。\n2.3 メンションが飛んできたらランダム文字列を生成して Slack に投稿 Slack Event API の app_mention を利用し、メンションを受けたらそのチャンネルにランダム生成された文字列を投稿します。\nfn post_anpanman(channel: String) { // 投稿文字列を決定する let body = create_body(); let token; match env::var(\"SLACK_BOT_TOKEN\") { Ok(t) =\u003e token = t, Err(message) =\u003e { println!(\"SLACK_BOT_TOKEN could not be used: {}\", message); return; } } let client; match slack::default_client() { Ok(c) =\u003e client = c, Err(message) =\u003e { println!(\"Failed to get a Slack client: {}\", message); return; } } match slack::chat::post_message( \u0026client, \u0026token, \u0026PostMessageRequest { channel: \u0026channel, text: \u0026body, ..PostMessageRequest::default() }, ) { Ok(response) =\u003e println!(\"{:?}\", response.message), Err(message) =\u003e println!(\"Failed to post a message to Slack: {}\", message), } } fn create_body() -\u003e String { // ランダムに表示させたい絵文字たち let dat = [ \":sore_an:\", \":ike:\", \":anpanman_an:\", \":anpanman_pan:\", \":anpanman_man:\", \":aa:\", \":mama:\", \":an_papa:\", ]; let mut rng = rand::thread_rng(); let mut body = String::from(\":sore_an: :ike: \"); // 絵文字数の決定 (3～12) let length = rng.gen_range(3..=12); for _ in 0..length { // 絵文字の決定 let index = rng.gen_range(0..dat.len()); body.push_str(dat[index]); body.push_str(\" \"); } return body; } 3. Dockerfile を用意 Cloud Run にデプロイするために、 docker image を作る必要があるため、 Dockerfile を用意。 最初は 公式のドキュメント を見ながら作ったんですが、\nRustのDocker Build時間短縮したい - Zenn First steps with Docker + Rust - DEV Community このあたりを参考に、処理を見直してビルド時間を短縮したり、ビルド時とデプロイ時のベースとなる image を変えて軽量化したりしています。 本当は記事にもあるような debian:stable-slim みたいな軽量イメージを使いたかったんですが、これを使うと実行して Slack 投稿時に\nerror trying to connect: error:1416F086:SSL routines:tls_process_server_certificate:certificate verify failed と SSL 証明書周りでエラーが出てしまい、このあたり調べるのも大変そうだったので、 rust:slim で妥協。 誰か解決策教えてください（？）\n4. Cloud Run にデプロイ gcloud run deploy でデプロイをします。最初は何をやってるのか良くわかってなかったんですが、これを行うと\nCloud Storage にソースをアップロード Cloud Build で docker build ↑ で出来た image を Artifact Registry にアップロード Cloud Run で ↑ にアップロードされた image を実行 まで行われる模様。\nコマンド一つでいろいろやってくれるのは楽ちんだけど、中身を知るのは大変😅\n5. GitHub Actions で、リポジトリに push されたら自動でデプロイされるように 4.までで機能リリースとしては完了なんですが、折角なのでもうちょっと自動化を頑張ることに。 しかしここは GCP のサービスアカウントについてしっかり理解しないといけなかったため、めちゃくちゃ時間かかりました😩\n幸い、 GitHub Actions 側には Google 謹製の auth と deploy-cloudrun があり、ドキュメントに従えば概ねちゃんと動いてくれました。 ドキュメントをしっかり読まずにところどころ飛ばして読んだ所為でいろんなところで躓いてしまった…。\n以下、つまづいたことなど AWS の 2FA が通せなくなってた😇 半年程前にスマホを機種変更してたんですが、その時に Authenticator の切り替えに失敗し、 2FA ログインが出来なくなってましたｗ\nしかも、その場合用に SMS が飛んでくる仕組みだったぽいんですが、 AWS の電話番号入力は国際番号(+81)から入力すべきだったらしく、その入力も間違えていてお問い合わせベースでの対応に…。\nとりあえず動かしてみたいし、そもそも AWS も GCP もあんまり使った事が無かったので、 GCP でやってみるか、ということで GCP で作りました。\nCloud Run の使い方が不明 本当は Cloud Functions でサクッと作りたいな～とか思ってたんですが、 Rust は対象外であった… ということで、そもそも Rust の勉強がてら、というのがあったので、 Cloud Run を使って Rust で動かす、という方針に。\nしかし、 Cloud Run は使ったことが無かったので、「サーバー待ち受けのコードを書く必要がある」というところの理解までにしばらくかかりましたｗ\nCloud RunでRustのAPI Serverを動かす - Zenn の記事を参考にして、無事に動かすことが出来ました 🎉\nCloud Build でタイムアウトしてしまう Rust のコンパイルがそこそこ重い処理だったので、デフォルトの Cloud Build のスペック及びタイムアウト時間(10分)だとタイムアウトしていまうようでした。 これは、 gcloud config set builds/timeout \u003c指定秒数\u003e と設定しておくか、 CLOUDSDK_BUILDS_TIMEOUT 環境変数を定義しておくと変更出来るので、それで対処。\nなお、似たような設定値として app/cloud_build_timeout があるんですが、これは Google App Engine をデプロイするときのタイムアウト設定っぽい。紛らわしすぎる…これで1時間ほどハマってしまいました😩\nおわりに Rust の勉強がてら、ということでやってみたんですが、どちらかというと GCP のお勉強になりました😅 サーバー周り、結構興味はあったんですが今まで真面目に触った事が無かったので、良いきっかけになったなーと思います。\nまたそのうちサーバー周りをいじる何かを作ろうと思います💪\n参考 Cloud RunでRustのAPI Serverを動かす - Zenn RustのDocker Build時間短縮したい - Zenn First steps with Docker + Rust - DEV Community クイックスタート: Cloud Run にサービスをデプロイする | Cloud Run のドキュメント | Google Cloud Move token to authorization header by silverjam · Pull Request #105 · slack-rs/slack-rs-api · GitHub Slack Appの作り方を丁寧に残す【BotとEvent APIの設定編】 - Zenn ","wordCount":"2676","inLanguage":"ja","datePublished":"2022-04-22T23:00:00+09:00","dateModified":"2022-04-22T23:00:00+09:00","author":{"@type":"Person","name":null},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.kusuha.com/posts/2022/04/create-slack-bot-with-cloud-run-and-rust/"},"publisher":{"@type":"Organization","name":"くすブロ","description":"くすはさんのブログです。日常だったり趣味だったり技術的なことだったりを書いていくよ。","logo":{"@type":"ImageObject","url":"https://blog.kusuha.com/favicon.ico"}}}</script><title>Google Cloud Run + Rust で Slack の bot を作ってみた</title>
<link rel="stylesheet dns-prefetch preconnect preload prefetch" as=style href=https://blog.kusuha.com/css/style.min.d3facc2d5fe42af72ee5a80584900a45ffee6035df0ef582bd8696c2fe0c9da5.css integrity="sha256-0/rMLV/kKvcu5agFhJAKRf/uYDXfDvWCvYaWwv4MnaU=" crossorigin=anonymous></head><body id=page><header id=site-header><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://blog.kusuha.com/>くすブロ</a></div><nav class="site-nav hide-in-mobile"><a href=https://blog.kusuha.com/posts/>Posts</a></nav></div><div class="hdr-right hdr-icons"><button id=menu-btn class=hdr-btn title=Menu><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://blog.kusuha.com/posts/>Posts</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-date><span>Apr 22, 2022</span></div><h1>Google Cloud Run + Rust で Slack の bot を作ってみた</h1></header><div class=post-description><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://blog.kusuha.com/tags/gcp>GCP</a></span><span class=tag><a href=https://blog.kusuha.com/tags/rust>Rust</a></span><span class=tag><a href=https://blog.kusuha.com/tags/slack>Slack</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=category><a href=https://blog.kusuha.com/categories/%E6%8A%80%E8%A1%93>技術</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>2676 2676 Words</p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2022/04/22 23:00</p></div><hr class=post-end><div class=content><p>最近、趣味で <a href=https://www.rust-lang.org/ja>Rust</a> を触っているんですが、その勉強の一環で Slack bot を作ってみたので、その備忘録。</p><h1 id=できたもの>できたもの<a href=#%e3%81%a7%e3%81%8d%e3%81%9f%e3%82%82%e3%81%ae class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p><a href=https://github.com/dj-kusuha/soreike><img src=feature.png></a></p><p><img src=2022-04-11-00-17-09.png alt=それいけ！アンいけ！アンアンパン></p><h2 id=使った物>使った物<a href=#%e4%bd%bf%e3%81%a3%e3%81%9f%e7%89%a9 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li>Rust</li><li>Google Cloud Platform<ul><li><a href="https://cloud.google.com/run?hl=ja">Cloud Run</a></li><li>Artifact Registry</li><li>Cloud Build</li><li>Cloud Logging</li><li>Cloud Storage<ul><li>上記4つは Google Cloud CLI で <code>gcloud run deploy</code> すると使われるものたち</li></ul></li><li>Secret Manager</li></ul></li></ul><h1 id=なぜこれを作ったのか>なぜこれを作ったのか<a href=#%e3%81%aa%e3%81%9c%e3%81%93%e3%82%8c%e3%82%92%e4%bd%9c%e3%81%a3%e3%81%9f%e3%81%ae%e3%81%8b class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><blockquote><p>Slackでアンパンマンがちょっと流行った話 / Zenn.dev
<a href=https://zenn.dev/dividebyzero/articles/2815cef7cd446f>https://zenn.dev/dividebyzero/articles/2815cef7cd446f</a></p></blockquote><p>この記事を読んだのがきっかけ。ちょうど手頃な Slack bot だったので、 bot をデプロイするまでの一連の勉強には良いかなと。</p><p>あとは、このツイート記事を読んだことで「オッ AWS Lambda だけで完結して作れるじゃん」と思って機運が高まったのが着手の要因に。</p><blockquote class=twitter-tweet><p lang=ja dir=ltr>ついに API-GW なしに Lambda だけで HTTPS なエンドポイントを生やせるように・・・！<br><br>GitHub とか Slack からの Webhook 受けとしても使いやすくなるし、良いすね🤗<br><br>/ "AWS Lambda Function URLs: built-in HTTPS endpoints for your Lambda functions" <a href=https://t.co/Evs4OAL2Iv>https://t.co/Evs4OAL2Iv</a> <a href=https://t.co/zaEb3Epeo2>pic.twitter.com/zaEb3Epeo2</a></p>&mdash; Tori Hara (@toricls) <a href="https://twitter.com/toricls/status/1511842011933863936?ref_src=twsrc%5Etfw">April 6, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>(何故AWSではなくGCPで実装することになったのかは後述)</p><h1 id=やったこと>やったこと<a href=#%e3%82%84%e3%81%a3%e3%81%9f%e3%81%93%e3%81%a8 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><h2 id=1-slack-で-bot-アプリケーションを新規作成>1. Slack で bot アプリケーションを新規作成<a href=#1-slack-%e3%81%a7-bot-%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%82%92%e6%96%b0%e8%a6%8f%e4%bd%9c%e6%88%90 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p><a href=https://zenn.dev/mokomoka/articles/6d281d27aa344e>Slack Appの作り方を丁寧に残す【BotとEvent APIの設定編】 - Zenn</a></p><p>上記記事がかなり詳しく書いてくれていて、ほぼこれの通りに作ったので、詳細は割愛。</p><h2 id=2-rust-でコーディング>2. Rust でコーディング<a href=#2-rust-%e3%81%a7%e3%82%b3%e3%83%bc%e3%83%87%e3%82%a3%e3%83%b3%e3%82%b0 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><h3 id=21-サーバー待ち受け>2.1 サーバー待ち受け<a href=#21-%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc%e5%be%85%e3%81%a1%e5%8f%97%e3%81%91 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p><a href=https://zenn.dev/kowaremonoid/articles/7e077f9eb4439b>Cloud RunでRustのAPI Serverを動かす - Zenn</a></p><p>まず、上記記事を参考に、 Rust でサーバー待ち受けのコードを用意。ここも詳細割愛。</p><h3 id=22-slack-url-verification-を通す>2.2 Slack URL Verification を通す<a href=#22-slack-url-verification-%e3%82%92%e9%80%9a%e3%81%99 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>その後、Slack App でイベントを受け取るために、 <a href=https://api.slack.com/apis/connections/events-api#the-events-api__subscribing-to-event-types__events-api-request-urls__request-url-configuration--verification0>URL Verification</a> を通す必要があるので、そのコードを用意。
ここも、 1. で参考にした記事を参考にしています。</p><p>やっていることはシンプルで、 1. で作った時に発行されている <code>Verification Token</code> を環境変数 <code>SLACK_VERIFICATION_TOKEN</code> に定義しておき、それと <code>token</code> との一致確認と、 <code>type</code> が <code>url_verification</code> であるかを確認して、問題が無ければ <code>challenge</code> の内容を JSON 形式で返しています。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>slack</span><span class=p>(</span><span class=n>Json</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>: <span class=nc>Json</span><span class=o>&lt;</span><span class=n>SlackRequest</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>impl</span><span class=w> </span><span class=n>IntoResponse</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=n>env</span>::<span class=n>var</span><span class=p>(</span><span class=s>&#34;SLACK_VERIFICATION_TOKEN&#34;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>token</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=n>payload</span><span class=p>.</span><span class=n>token</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>StatusCode</span>::<span class=no>UNAUTHORIZED</span><span class=p>,</span><span class=w> </span><span class=nb>String</span>::<span class=n>new</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;SLACK_VERIFICATION_TOKEN is not available: </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>StatusCode</span>::<span class=no>INTERNAL_SERVER_ERROR</span><span class=p>,</span><span class=w> </span><span class=nb>String</span>::<span class=n>new</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>r#type</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>payload</span><span class=p>.</span><span class=n>r#type</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>r#type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s>&#34;url_verification&#34;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>match</span><span class=w> </span><span class=n>payload</span><span class=p>.</span><span class=n>challenge</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nb>Some</span><span class=p>(</span><span class=n>challenge</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>StatusCode</span>::<span class=no>OK</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=fm>format!</span><span class=p>(</span><span class=sa>r</span><span class=s>#&#34;{{&#34;challenge&#34;:&#34;{}&#34;}}&#34;#</span><span class=p>,</span><span class=w> </span><span class=n>challenge</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nb>None</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>StatusCode</span>::<span class=no>BAD_REQUEST</span><span class=p>,</span><span class=w> </span><span class=nb>String</span>::<span class=n>new</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>StatusCode</span>::<span class=no>OK</span><span class=p>,</span><span class=w> </span><span class=nb>String</span>::<span class=n>new</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>なお、環境変数への定義は、デプロイ時には Secret Manager を利用しつつ、開発中は <code>.env</code> ファイルを作ってそこに環境変数を定義し、 <a href=https://crates.io/crates/dotenv>rust-dotenv</a> crate を使って読み込んでいます。</p><h3 id=23-メンションが飛んできたらランダム文字列を生成して-slack-に投稿>2.3 メンションが飛んできたらランダム文字列を生成して Slack に投稿<a href=#23-%e3%83%a1%e3%83%b3%e3%82%b7%e3%83%a7%e3%83%b3%e3%81%8c%e9%a3%9b%e3%82%93%e3%81%a7%e3%81%8d%e3%81%9f%e3%82%89%e3%83%a9%e3%83%b3%e3%83%80%e3%83%a0%e6%96%87%e5%ad%97%e5%88%97%e3%82%92%e7%94%9f%e6%88%90%e3%81%97%e3%81%a6-slack-%e3%81%ab%e6%8a%95%e7%a8%bf class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>Slack Event API の <a href=https://api.slack.com/events/app_mention>app_mention</a> を利用し、メンションを受けたらそのチャンネルにランダム生成された文字列を投稿します。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=k>fn</span> <span class=nf>post_anpanman</span><span class=p>(</span><span class=n>channel</span>: <span class=nb>String</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 投稿文字列を決定する
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>body</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>create_body</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>token</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=n>env</span>::<span class=n>var</span><span class=p>(</span><span class=s>&#34;SLACK_BOT_TOKEN&#34;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;SLACK_BOT_TOKEN could not be used: </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>client</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=n>slack</span>::<span class=n>default_client</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>client</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>c</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Failed to get a Slack client: </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=n>slack</span>::<span class=n>chat</span>::<span class=n>post_message</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=n>client</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=n>token</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=n>PostMessageRequest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channel</span>: <span class=kp>&amp;</span><span class=nc>channel</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>text</span>: <span class=kp>&amp;</span><span class=nc>body</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>..</span><span class=n>PostMessageRequest</span>::<span class=n>default</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{:?}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>.</span><span class=n>message</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Failed to post a message to Slack: </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>create_body</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>String</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ランダムに表示させたい絵文字たち
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>dat</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;:sore_an:&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;:ike:&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;:anpanman_an:&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;:anpanman_pan:&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;:anpanman_man:&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;:aa:&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;:mama:&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;:an_papa:&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>rng</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rand</span>::<span class=n>thread_rng</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>body</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>String</span>::<span class=n>from</span><span class=p>(</span><span class=s>&#34;:sore_an: :ike: &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 絵文字数の決定 (3～12)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rng</span><span class=p>.</span><span class=n>gen_range</span><span class=p>(</span><span class=mi>3</span><span class=o>..=</span><span class=mi>12</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>_</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..</span><span class=n>length</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 絵文字の決定
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rng</span><span class=p>.</span><span class=n>gen_range</span><span class=p>(</span><span class=mi>0</span><span class=o>..</span><span class=n>dat</span><span class=p>.</span><span class=n>len</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>body</span><span class=p>.</span><span class=n>push_str</span><span class=p>(</span><span class=n>dat</span><span class=p>[</span><span class=n>index</span><span class=p>]);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>body</span><span class=p>.</span><span class=n>push_str</span><span class=p>(</span><span class=s>&#34; &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>body</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=3-dockerfile-を用意>3. Dockerfile を用意<a href=#3-dockerfile-%e3%82%92%e7%94%a8%e6%84%8f class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>Cloud Run にデプロイするために、 docker image を作る必要があるため、 Dockerfile を用意。
最初は <a href=https://cloud.google.com/run/docs/quickstarts/build-and-deploy/deploy-service-other-languages>公式のドキュメント</a> を見ながら作ったんですが、</p><ul><li><a href=https://zenn.dev/ucwork/articles/acec204571362b>RustのDocker Build時間短縮したい - Zenn</a></li><li><a href=https://dev.to/rogertorres/first-steps-with-docker-rust-30oi>First steps with Docker + Rust - DEV Community</a></li></ul><p>このあたりを参考に、処理を見直してビルド時間を短縮したり、ビルド時とデプロイ時のベースとなる image を変えて軽量化したりしています。
本当は記事にもあるような <code>debian:stable-slim</code> みたいな軽量イメージを使いたかったんですが、これを使うと実行して Slack 投稿時に</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>error trying to connect: error:1416F086:SSL routines:tls_process_server_certificate:certificate verify failed
</span></span></code></pre></div><p>と SSL 証明書周りでエラーが出てしまい、このあたり調べるのも大変そうだったので、 <code>rust:slim</code> で妥協。
誰か解決策教えてください（？）</p><h2 id=4-cloud-run-にデプロイ>4. Cloud Run にデプロイ<a href=#4-cloud-run-%e3%81%ab%e3%83%87%e3%83%97%e3%83%ad%e3%82%a4 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p><code>gcloud run deploy</code> でデプロイをします。最初は何をやってるのか良くわかってなかったんですが、これを行うと</p><ol><li>Cloud Storage にソースをアップロード</li><li>Cloud Build で docker build</li><li>↑ で出来た image を Artifact Registry にアップロード</li><li>Cloud Run で ↑ にアップロードされた image を実行</li></ol><p>まで行われる模様。</p><p>コマンド一つでいろいろやってくれるのは楽ちんだけど、中身を知るのは大変😅</p><h2 id=5-github-actions-でリポジトリに-push-されたら自動でデプロイされるように>5. GitHub Actions で、リポジトリに push されたら自動でデプロイされるように<a href=#5-github-actions-%e3%81%a7%e3%83%aa%e3%83%9d%e3%82%b8%e3%83%88%e3%83%aa%e3%81%ab-push-%e3%81%95%e3%82%8c%e3%81%9f%e3%82%89%e8%87%aa%e5%8b%95%e3%81%a7%e3%83%87%e3%83%97%e3%83%ad%e3%82%a4%e3%81%95%e3%82%8c%e3%82%8b%e3%82%88%e3%81%86%e3%81%ab class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>4.までで機能リリースとしては完了なんですが、折角なのでもうちょっと自動化を頑張ることに。
しかしここは GCP のサービスアカウントについてしっかり理解しないといけなかったため、めちゃくちゃ時間かかりました😩</p><p>幸い、 GitHub Actions 側には Google 謹製の <a href=https://github.com/google-github-actions/auth>auth</a> と <a href=https://github.com/google-github-actions/deploy-cloudrun>deploy-cloudrun</a> があり、ドキュメントに従えば概ねちゃんと動いてくれました。
ドキュメントをしっかり読まずにところどころ飛ばして読んだ所為でいろんなところで躓いてしまった…。</p><h1 id=以下つまづいたことなど>以下、つまづいたことなど<a href=#%e4%bb%a5%e4%b8%8b%e3%81%a4%e3%81%be%e3%81%a5%e3%81%84%e3%81%9f%e3%81%93%e3%81%a8%e3%81%aa%e3%81%a9 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><h2 id=aws-の-2fa-が通せなくなってた>AWS の 2FA が通せなくなってた😇<a href=#aws-%e3%81%ae-2fa-%e3%81%8c%e9%80%9a%e3%81%9b%e3%81%aa%e3%81%8f%e3%81%aa%e3%81%a3%e3%81%a6%e3%81%9f class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>半年程前にスマホを機種変更してたんですが、その時に Authenticator の切り替えに失敗し、 2FA ログインが出来なくなってましたｗ</p><p>しかも、その場合用に SMS が飛んでくる仕組みだったぽいんですが、 AWS の電話番号入力は国際番号(+81)から入力すべきだったらしく、その入力も間違えていてお問い合わせベースでの対応に…。</p><p>とりあえず動かしてみたいし、そもそも AWS も GCP もあんまり使った事が無かったので、 GCP でやってみるか、ということで GCP で作りました。</p><h2 id=cloud-run-の使い方が不明>Cloud Run の使い方が不明<a href=#cloud-run-%e3%81%ae%e4%bd%bf%e3%81%84%e6%96%b9%e3%81%8c%e4%b8%8d%e6%98%8e class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>本当は Cloud Functions でサクッと作りたいな～とか思ってたんですが、 Rust は対象外であった… ということで、そもそも Rust の勉強がてら、というのがあったので、 Cloud Run を使って Rust で動かす、という方針に。</p><p>しかし、 Cloud Run は使ったことが無かったので、「サーバー待ち受けのコードを書く必要がある」というところの理解までにしばらくかかりましたｗ</p><p><a href=https://zenn.dev/kowaremonoid/articles/7e077f9eb4439b>Cloud RunでRustのAPI Serverを動かす - Zenn</a> の記事を参考にして、無事に動かすことが出来ました 🎉</p><h2 id=cloud-build-でタイムアウトしてしまう>Cloud Build でタイムアウトしてしまう<a href=#cloud-build-%e3%81%a7%e3%82%bf%e3%82%a4%e3%83%a0%e3%82%a2%e3%82%a6%e3%83%88%e3%81%97%e3%81%a6%e3%81%97%e3%81%be%e3%81%86 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>Rust のコンパイルがそこそこ重い処理だったので、デフォルトの Cloud Build のスペック及びタイムアウト時間(10分)だとタイムアウトしていまうようでした。
これは、 <code>gcloud config set builds/timeout &lt;指定秒数></code> と設定しておくか、 <code>CLOUDSDK_BUILDS_TIMEOUT</code> 環境変数を定義しておくと変更出来るので、それで対処。</p><p>なお、似たような設定値として <code>app/cloud_build_timeout</code> があるんですが、これは Google App Engine をデプロイするときのタイムアウト設定っぽい。紛らわしすぎる…これで1時間ほどハマってしまいました😩</p><h1 id=おわりに>おわりに<a href=#%e3%81%8a%e3%82%8f%e3%82%8a%e3%81%ab class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p>Rust の勉強がてら、ということでやってみたんですが、どちらかというと GCP のお勉強になりました😅
サーバー周り、結構興味はあったんですが今まで真面目に触った事が無かったので、良いきっかけになったなーと思います。</p><p>またそのうちサーバー周りをいじる何かを作ろうと思います💪</p><h1 id=参考>参考<a href=#%e5%8f%82%e8%80%83 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><ul><li><a href=https://zenn.dev/kowaremonoid/articles/7e077f9eb4439b>Cloud RunでRustのAPI Serverを動かす - Zenn</a></li><li><a href=https://zenn.dev/ucwork/articles/acec204571362b>RustのDocker Build時間短縮したい - Zenn</a></li><li><a href=https://dev.to/rogertorres/first-steps-with-docker-rust-30oi>First steps with Docker + Rust - DEV Community</a></li><li><a href=https://cloud.google.com/run/docs/quickstarts/build-and-deploy/deploy-service-other-languages>クイックスタート: Cloud Run にサービスをデプロイする | Cloud Run のドキュメント | Google Cloud</a></li><li><a href=https://github.com/slack-rs/slack-rs-api/pull/105>Move token to authorization header by silverjam · Pull Request #105 · slack-rs/slack-rs-api · GitHub</a></li><li><a href=https://zenn.dev/mokomoka/articles/6d281d27aa344e>Slack Appの作り方を丁寧に残す【BotとEvent APIの設定編】 - Zenn</a></li></ul></div></article><div class="post-nav thin"><a class=next-post href=https://blog.kusuha.com/posts/2022/07/pass_fp2/><span class=post-nav-label><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;Newer</span><br><span>2級FP技能検定に合格しました</span>
</a><a class=prev-post href=https://blog.kusuha.com/posts/2022/04/hotspring_cure/><span class=post-nav-label>Older&nbsp;<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>豊富温泉に湯治で行ってきました</span></a></div><div id=comments class=thin></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2025 <a href=https://blog.kusuha.com/>くすブロ</a>
&#183; Copyright © くすは; all rights reserved.&#183; Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a>
&#183; Theme <a href=https://github.com/1bl4z3r/hermit-V2 target=_blank rel=noopener>Hermit-V2</a></p></footer><script async src=https://blog.kusuha.com/js/bundle.min.c7c384e4d29d192bbac6811ae4660bb01767194a5bea56baca77e8260f93ea16.js integrity="sha256-x8OE5NKdGSu6xoEa5GYLsBdnGUpb6la6ynfoJg+T6hY=" crossorigin=anonymous></script></body></html>